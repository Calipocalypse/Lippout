<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Lippout</title>
    <base href="/" />
    <link rel="stylesheet" href="_content/WebviewAppShared/css/bootstrap/bootstrap.min.css" />
    <link href="_content/WebviewAppShared/css/site.css" rel="stylesheet" />
    <link href="BlazorWpfApp.styles.css" rel="stylesheet" />
    <link href="index.css" rel="stylesheet" />
    <script src="chart.min.js"></script>
    <script src="chartjs-plugin-dragdata.min.js"></script>
    <script src="wavesurfer.min.js"></script>
</head>

<body>
    <div id="debug" style="background-color: black; color: lime;"></div>
    <div id="app"></div>
    <script type="text/javascript">
        var console = {};
        var logger = document.getElementById("debug");
        console.log = function (text) {
            var element = document.createElement("div");
            var txt = document.createTextNode(text);

            element.appendChild(txt);
            logger.appendChild(element);
        }
        console.log("Starting logger...");
            * /
    </script>
    <script src="_framework/blazor.webview.js"></script>

    <script>
        //switcher
        var idDivImages = ["frame0", "frame1", "frame2", "frame3", "frame4", "frame5", "frame6", "frame7", "frame8"];
        var displayedFrame = 0;

        function onStartDivImages() {
            try {
                idDivImages.forEach(x => document.getElementById(x).style.display = 'none');
                document.getElementById("frame0").style.display = 'block';
            }
            catch (error) {
                alert(error);
            }
        }

        function updateFrame(time) {
            var data = JSON.parse(JSON.stringify(theChart.data.datasets[0].data));
            let foundElement = null;

            for (const element of data) {
                if (element.x > time) {
                    foundElement = element;
                    break;
                }
            }

            if (foundElement != null) {
                document.getElementById("phonemFrame").textContent = JSON.stringify(foundElement);
                changeFrame(Math.floor(foundElement.y));
            }

        }

        function changeFrame(newFrame) {
            try {
                if (displayedFrame != newFrame) {
                    displayedFrame = newFrame;
                    idDivImages.forEach(x => document.getElementById(x).style.display = 'none');
                    document.getElementById(idDivImages[newFrame]).style.display = 'block';
                }
            }
            catch (error) {
                alert(error);
            }
        }
    </script>

    <script>
        function loadWaveForm() {
            var markerOffsetFixed = 0;
            var timerSlowDown = 0;

            const wavesurfer = WaveSurfer.create({
                container: '#waveform',
                waveColor: 'lime',
                progressColor: 'red',
                url: '/LIEUT1.wav'
            })

            wavesurfer.on('interaction', () => {
                wavesurfer.play()
            })

            wavesurfer.on('timeupdate', function () {
                if (timerSlowDown > 3) {
                    var currentTime = wavesurfer.getCurrentTime();
                    var markerOffset = 22100 * 4 * currentTime;
                    markerOffsetFixed = markerOffset.toFixed();
                    document.getElementById("debugDiv").textContent = markerOffsetFixed;
                    updateFrame(markerOffsetFixed);
                    timerSlowDown = 0;
                }
                else {
                    timerSlowDown++;
                }
            });

            wavesurfer.on('click', function () {
                var currentTime = wavesurfer.getCurrentTime();
                var markerOffset = 22100 * 4 * currentTime;
            });
        }

    </script>
    <script>
        var theChart = null;

        var options = {
            // IMPORTANT - You need a chart of type "scatter"
            // in order to drag a line chart along the x axis
            type: 'scatter',
            data: {
                "datasets": [
                    {
                        "label": "A dataset",
                        "data": [
                            {
                                "x": 0,
                                "y": 5
                            },
                            {
                                "x": 512788,
                                "y": 1
                            }
                        ],
                        "backgroundColor": "rgba(255, 99, 132, 1)",
                        borderWidth: 5.5,
                        fill: false,
                        pointRadius: 10,
                        pointHitRadius: 25,
                        showLine: true
                    }
                ]
            },
            options: {
                layout: {
                    padding: {
                        left: 20,
                        right: 20,
                        top: 20,
                        bottom: 10
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: '#00000000'
                        },
                        min: 0,
                        max: 20000700
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: '#ff0000'
                        },
                        min: 0,
                        max: 8.9
                    }
                },
                plugins: {
                    dragData: {
                        round: 1,
                        showTooltip: true,
                        // IMPORTANT - you also need to specify dragX
                        dragX: true
                    }
                }
            }
        }

        function loadMarkersUi() {
            console.log(document.getElementById('markersContainer'));
            var ctx = document.getElementById('markersContainer').getContext('2d');
            theChart = new Chart(ctx, options);
            theChart.canvas.parentNode.style.height = '512px';
            theChart.canvas.parentNode.style.width = '100%';
        }

        function loadNewLipData() {
            try {

                let newdata = [
                    {
                        "label": "A dataset",
                        "data": [],
                        "backgroundColor": "rgba(255, 99, 132, 1)",
                        "borderWidth": 5.5,
                        "fill": false,
                        "pointRadius": 10,
                        "pointHitRadius": 25,
                        "showLine": true
                    }];


                theChart.data.datasets = newdata;
                theChart.update();
            }
            catch (error) {
                alert(error);
            }
        }

        function getMarkersPhonemData() {
            var data = JSON.parse(JSON.stringify(theChart.data.datasets[0].data));

            data.forEach(point => {
                point.marker = point.x;
                delete point.x;
                point.phonem = point.y;
                delete point.y;
            });
            var toReturn = JSON.stringify(data);
            alert(JSON.stringify(toReturn));
            return toReturn;
        }

        function putNewMarker(markerPos, phonemPos) {
            newData2 = { "x": markerPos, "y": phonemPos };

            theChart.data.datasets.forEach((dataset) => {
                dataset.data.push(newData2);
            });
            theChart.update();
        }

        function loadLipMarkers(phonomarkers) {
            var phonomarkers = JSON.parse(phonomarkers);
            max_x = phonomarkers[phonomarkers.length - 1].markerPos;
            alert(phonomarkers.length);
            options.options.scales.x.max = max_x;
            theChart.clear();
            loadNewLipData();
            phonomarkers.forEach((phonomarker) => {
                newData3 = { "x": phonomarker.markerPos, "y": phonomarker.phonemPos };
                theChart.data.datasets[0].data.push(newData3);
            })
            theChart.update();
        }
    </script>
</body>

</html>